<?xml version="1.0" encoding="utf-8"?>
<etlflow>
    <configs>
        <define type="pb_collector" pb_file="conf/weibo.proto" pb_type="WeiboSearch" name="des" is_dync="true"/>
        <define type="pb_collector" pb_file="conf/weibo.proto" pb_type="Tmp" name="tmp" is_dync="true"/>
		<so_loader so_path="so" so_file="libweibosearch.so" />
    </configs>

    <!--datasource type="dstream" from="line" pb_or_txt="1" id="dstreamActionId" guid_file_path="conf/GUID.list"/-->
    
	<datasource type="bigpipe" need_compack="true" pipe_name="spider-weibo-search-pipe" pipe_token="BmlrSo-SUB" pipe_num="3" start_msg_no="-1" conf_path="./conf" conf_file="bigpipe_yd.conf" is_pb_or_txt="1"  name="line"/>
	
	<fieldmap type="common_copy" from="line" to="tmp.content" absolute_path="true"/>

    <!--multithread threads="{threads}"-->
    <!--multithread threads="3"-->
	
	<fieldmap type="common_copy" from="meta.stime" to="des.logagent_time" test="has(meta.stime)" absolute_path="true"/>

	<string_to_array from="tmp.content" to="tmp_time,des.weibo_user_id,des.weibo_search_type,des.event_query,tmp_device" selector="0,1,2,3,4" delimiter="&#x0009;" absolute_path="true"/>

	<fieldmap type="common_copy" from="des.weibo_user_id" to="des.weibo_user_id" test="!empty($from)" on_test_fail="drop" absolute_path="true"/>

	<transform type="parse_time" from="tmp_time" format="%d/%b/%Y:%H:%M:%S" to="des.event_timestamp" absolute_path="true"/>
	<fieldmap type="common_copy" from="des.event_timestamp" to="des.time" absolute_path="true"/>
	<fieldmap type="cfunc" func="CompUserAgent" from="tmp_device" to="event_brand,des.event_device,des.event_device_version,des.event_browser,des.event_browser_version,des.event_os,des.event_os_version,event_useragent,event_client_type" test="!empty($from)"/>

    <!--packet type="compack" log_type="25" version="1" from="des" to="compack" hash_name="des.weibo_user_id" absolute_path="true"/-->

    <debug type="print_pb" from="des" absolute_path="true"/>
	<debug type="write_pb" from="des" column_delim="\t" kv_delim=":" field_noes="1-9,606,650" des_path="weibo_search_out.txt" null_value="-" />
    <!--dispatcher type="bigpipeCallBack" pipe_name="weibo-userid-event-pipe" pipe_token="oqTzso-PUB" conf_path="./conf" conf_file="bigpipe_out.conf" from="compack" absolute_path="true" ref_id="dstreamActionId" hash_name="des.weibo_user_id" from_bytes="1" absolute_path="true" singlton="true"/-->
    <!--/multithread-->

</etlflow>
